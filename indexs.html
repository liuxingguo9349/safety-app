<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨éšæ‚£éšæ‰‹æ‹ - å®ˆæŠ¤ç”Ÿæ´»æ¯ä¸€åˆ»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#FF6B6B',
                        accent: '#4ECDC4',
                        warning: '#FFE66D',
                        success: '#51CF66'
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'toast-in': 'toastIn 0.5s ease-out forwards',
                        'toast-out': 'toastOut 0.5s ease-in forwards',
                        'spin': 'spin 1s linear infinite'
                    },
                    keyframes: {
                        toastIn: { 'from': { transform: 'translateY(-100%)', opacity: '0' }, 'to': { transform: 'translateY(0)', opacity: '1' } },
                        toastOut: { 'from': { transform: 'translateY(0)', opacity: '1' }, 'to': { transform: 'translateY(-100%)', opacity: '0' } },
                        spin: { to: { transform: 'rotate(360deg)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(93, 92, 222, 0.4);
            }

            50% {
                box-shadow: 0 0 30px rgba(93, 92, 222, 0.8);
            }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }

        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.9);
        }

        .hidden-file-input {
            display: none;
        }

        .gradient-text {
            background-image: linear-gradient(to right, #5D5CDE, #FF6B6B);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .dark #loader {
            background: rgba(17, 24, 39, 0.8);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }

        #cameraModal video {
            transform: scaleX(-1);
        }

        .preview-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #5D5CDE;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <div id="loader">
        <div class="spinner"></div>
        <p class="text-gray-600 dark:text-gray-300">æ­£åœ¨åŠ è½½å®‰å…¨æ•°æ®...</p>
    </div>
    <div id="app" class="min-h-screen hidden">
        <nav class="glass-effect fixed top-0 left-0 right-0 z-50 border-b border-gray-200/50 dark:border-gray-700/50">
            <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div
                        class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white text-sm"></i>
                    </div>
                    <span id="pageTitle" class="font-bold text-gray-800 dark:text-white">å®‰å…¨éšæ‚£éšæ‰‹æ‹</span>
                </div>
            </div>
        </nav>

        <main class="pt-20 pb-20">
            <section id="home" class="page active">
                <div class="gradient-bg text-white py-12 px-4">
                    <div class="max-w-md mx-auto text-center">
                        <div class="animate-float mb-6">
                            <div
                                class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-camera text-4xl"></i>
                            </div>
                        </div>
                        <h1 class="text-3xl font-bold mb-4">å®ˆæŠ¤ç”Ÿæ´»æ¯ä¸€åˆ»</h1>
                        <p class="text-white/90 mb-4">å‘ç°éšæ‚£ï¼ŒåŠæ—¶æŠ¥å‘Šï¼Œå…±å»ºå®‰å…¨å®¶å›­</p>

                        <button id="startBtn"
                            class="bg-white text-primary px-8 py-3 rounded-full font-semibold hover:shadow-lg transition-all animate-pulse-glow">å¼€å§‹ä½“éªŒ</button>
                    </div>
                </div>
                <div class="px-4 py-8">
                    <div class="max-w-md mx-auto space-y-8">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
                                <div
                                    class="w-12 h-12 bg-gradient-to-r from-red-400 to-pink-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-fire text-white text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 dark:text-white mb-1">æ¶ˆé˜²å®‰å…¨</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">é¢„é˜²ç«ç¾é£é™©</p>
                            </div>
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
                                <div
                                    class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-hard-hat text-white text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 dark:text-white mb-1">ç”Ÿäº§å®‰å…¨</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">å·¥ä½œåœºæ‰€å®‰å…¨</p>
                            </div>
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
                                <div
                                    class="w-12 h-12 bg-gradient-to-r from-green-400 to-blue-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-home text-white text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 dark:text-white mb-1">ç”Ÿæ´»å®‰å…¨</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">æ—¥å¸¸ç”Ÿæ´»é˜²æŠ¤</p>
                            </div>
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
                                <div
                                    class="w-12 h-12 bg-gradient-to-r from-purple-400 to-indigo-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 dark:text-white mb-1">é˜²ç¾å‡ç¾</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">è‡ªç„¶ç¾å®³é˜²èŒƒ</p>
                            </div>
                        </div>
                        <!-- å®˜æ–¹æœºæ„ä¿¡æ¯ -->
                        <div
                            class="bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 p-6 rounded-2xl shadow-md border border-red-200 dark:border-red-800">
                            <div class="text-center">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-shield-alt text-red-600 text-2xl mr-2"></i>
                                    <h3 class="text-lg font-bold text-red-800 dark:text-red-200">å®˜æ–¹æŒ‡å¯¼</h3>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <a href="https://www.mem.gov.cn/?method=exPlay&id=1988" target="_blank"
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                                        <i class="fas fa-external-link-alt mr-2"></i>åº”æ€¥ç®¡ç†éƒ¨å®˜ç½‘
                                    </a>
                                    <a href="https://mempe.org.cn/" target="_blank"
                                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                                        <i class="fas fa-graduation-cap mr-2"></i>å›½å®¶åº”æ€¥ç®¡ç†å®£æ•™ç½‘
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- åº”æ€¥ä¸¾æŠ¥ç”µè¯ -->
                        <div
                            class="bg-gradient-to-r from-yellow-50 to-red-50 dark:from-yellow-900/20 dark:to-red-900/20 p-6 rounded-2xl shadow-md border border-yellow-200 dark:border-yellow-800">
                            <div class="text-center mb-4">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-phone-alt text-red-600 text-2xl mr-2"></i>
                                    <h3 class="text-lg font-bold text-red-800 dark:text-red-200">åº”æ€¥ä¸¾æŠ¥çƒ­çº¿</h3>
                                </div>
                                <p class="text-red-700 dark:text-red-300 text-sm mb-4">å‘ç°å®‰å…¨éšæ‚£ï¼Œè¯·åŠæ—¶ä¸¾æŠ¥</p>
                            </div>

                            <div class="grid grid-cols-1 gap-3">
                                <!-- å…¨å›½ç»Ÿä¸€ä¸¾æŠ¥ç”µè¯ -->
                                <div
                                    class="bg-red-100 dark:bg-red-900/30 p-3 rounded-lg border border-red-300 dark:border-red-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                            <span
                                                class="text-sm font-medium text-red-800 dark:text-red-200">å…¨å›½å®‰å…¨ç”Ÿäº§ä¸¾æŠ¥</span>
                                        </div>
                                        <a href="tel:12350"
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">
                                            12350
                                        </a>
                                    </div>
                                </div>

                                <!-- æµ·ä¸Šæœæ•‘ç”µè¯ -->
                                <div
                                    class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg border border-blue-300 dark:border-blue-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-anchor text-blue-600 mr-2"></i>
                                            <span
                                                class="text-sm font-medium text-blue-800 dark:text-blue-200">æµ·ä¸Šæœæ•‘ä¸­å¿ƒ</span>
                                        </div>
                                        <a href="tel:12395"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">
                                            12395
                                        </a>
                                    </div>
                                </div>

                                <!-- æ¶ˆé˜²æ•‘æ´ç”µè¯ -->
                                <div
                                    class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-lg border border-orange-300 dark:border-orange-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-fire-extinguisher text-orange-600 mr-2"></i>
                                            <span
                                                class="text-sm font-medium text-orange-800 dark:text-orange-200">æ¶ˆé˜²æ•‘æ´</span>
                                        </div>
                                        <a href="tel:119"
                                            class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">
                                            119
                                        </a>
                                    </div>
                                </div>

                                <!-- åŒ»ç–—æ€¥æ•‘ç”µè¯ -->
                                <div
                                    class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg border border-green-300 dark:border-green-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-ambulance text-green-600 mr-2"></i>
                                            <span
                                                class="text-sm font-medium text-green-800 dark:text-green-200">åŒ»ç–—æ€¥æ•‘</span>
                                        </div>
                                        <a href="tel:120"
                                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">
                                            120
                                        </a>
                                    </div>
                                </div>

                                <!-- æŠ¥è­¦ç”µè¯ -->
                                <div
                                    class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-lg border border-purple-300 dark:border-purple-700">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-shield-alt text-purple-600 mr-2"></i>
                                            <span
                                                class="text-sm font-medium text-purple-800 dark:text-purple-200">å…¬å®‰æŠ¥è­¦</span>
                                        </div>
                                        <a href="tel:110"
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">
                                            110
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <p class="text-xs text-gray-600 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ç´§æ€¥æƒ…å†µè¯·ç«‹å³æ‹¨æ‰“ç›¸åº”ç”µè¯
                                </p>
                            </div>
                        </div>

                        <!-- ä½œè€…ä¿¡æ¯ -->
                        <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-md">
                            <div class="text-center text-gray-600 dark:text-gray-300">
                                <p class="flex items-center justify-center text-sm"><i
                                        class="fas fa-university mr-2 text-primary"></i>ä¸­å›½æµ·æ´‹å¤§å­¦ Â· ä¸‰äºšæµ·æ´‹ç ”ç©¶é™¢</p>
                                <div class="mt-3 flex items-center justify-center text-sm"><span
                                        class="flex items-center mr-4"><i
                                            class="fas fa-code mr-2 text-primary"></i>è®¡ç®—æœºæŠ€æœ¯</span><span
                                        class="flex items-center"><i
                                            class="fas fa-user-graduate mr-2 text-primary"></i><span
                                            class="font-bold text-base gradient-text">åˆ˜å…´å›½</span></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å­¦ä¹ ä¸»é¡µé¢ -->
            <section id="learning" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">å®‰å…¨å­¦ä¹ ä¸­å¿ƒ</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <!-- å®‰å…¨çŸ¥è¯†åº“ -->
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg cursor-pointer"
                                onclick="showPage('knowledge')">
                                <div class="flex items-center">
                                    <div
                                        class="w-16 h-16 bg-gradient-to-r from-blue-400 to-purple-400 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-book text-white text-2xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">å®‰å…¨çŸ¥è¯†ç‚¹</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">å…¨é¢çš„å®‰å…¨çŸ¥è¯†ç‚¹å­¦ä¹ </p>
                                        <div class="flex items-center mt-2">
                                            <span
                                                class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded-full text-xs">åŸºç¡€çŸ¥è¯†</span>
                                            <i class="fas fa-chevron-right text-gray-400 ml-auto"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æµ·æ´‹å®‰å…¨æ•™è‚² -->
                            <div class="card-hover bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg cursor-pointer"
                                onclick="showPage('marine-safety')">
                                <div class="flex items-center">
                                    <div
                                        class="w-16 h-16 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-water text-white text-2xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">æµ·æ´‹å®‰å…¨æ•™è‚²</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">é’å²›Â·ä¸‰äºšç‰¹è‰²æµ·æ´‹å®‰å…¨çŸ¥è¯†</p>
                                        <div class="flex items-center mt-2">
                                            <span
                                                class="bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-300 px-2 py-1 rounded-full text-xs">ç‰¹è‰²æ•™è‚²</span>
                                            <span
                                                class="bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 px-2 py-1 rounded-full text-xs ml-2">æµ·æ´‹å¤§å­¦</span>
                                            <i class="fas fa-chevron-right text-gray-400 ml-auto"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å­¦ä¹ ç»Ÿè®¡ -->
                        <div
                            class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl shadow-md mt-6">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                                <i class="fas fa-chart-line text-green-600 mr-2"></i>çŸ¥è¯†åº“
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="knowledgeCount">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">çŸ¥è¯†ç‚¹</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-cyan-600" id="marineCount">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">æµ·æ´‹å®‰å…¨</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å®‰å…¨çŸ¥è¯†åº“é¡µé¢ -->
            <section id="knowledge" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <div class="flex items-center mb-4">
                            <button onclick="showPage('learning')"
                                class="mr-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-arrow-left text-gray-600 dark:text-gray-400"></i>
                            </button>
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">å®‰å…¨çŸ¥è¯†åº“</h2>
                        </div>
                        <div class="relative mb-4"><input type="search" id="knowledgeSearch" placeholder="æœç´¢çŸ¥è¯†ç‚¹..."
                                class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"><i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                        <div class="space-y-4" id="knowledgeCards"></div>
                        <div id="knowledgePagination" class="flex justify-center items-center flex-wrap gap-2 mt-6">
                        </div>
                    </div>
                </div>
            </section>

            <!-- æµ·æ´‹å®‰å…¨æ•™è‚²é¡µé¢ -->
            <section id="marine-safety" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <div class="flex items-center mb-4">
                            <button onclick="showPage('learning')"
                                class="mr-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-arrow-left text-gray-600 dark:text-gray-400"></i>
                            </button>
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">æµ·æ´‹å®‰å…¨æ•™è‚²</h2>
                        </div>
                        <div class="relative mb-4"><input type="search" id="marineSearch" placeholder="æœç´¢æµ·æ´‹å®‰å…¨çŸ¥è¯†..."
                                class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"><i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                        <div class="space-y-4" id="marineCards"></div>
                        <div id="marinePagination" class="flex justify-center items-center flex-wrap gap-2 mt-6">
                        </div>
                    </div>
                </div>
            </section>
            <section id="capture" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <h2 id="captureTitle" class="text-2xl font-bold text-gray-800 dark:text-white mb-6">æ–°å¢éšæ‚£æŠ¥å‘Š</h2>
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6"><input type="hidden"
                                id="reportId"><input type="file" id="mobileCameraInput" class="hidden-file-input"
                                accept="image/*" capture="environment"><input type="file" id="uploadInput"
                                class="hidden-file-input" accept="image/*">
                            <div class="text-center mb-6">
                                <div id="photoPreview"
                                    class="w-32 h-32 bg-gray-100 dark:bg-gray-700 rounded-2xl flex items-center justify-center mx-auto mb-4 cursor-pointer">
                                    <i class="fas fa-camera text-4xl text-gray-400"></i>
                                </div>
                                <div class="flex gap-4"><button id="takePhotoBtn"
                                        class="flex-1 bg-sky-500 text-white px-4 py-3 rounded-full font-semibold flex items-center justify-center gap-2"><i
                                            class="fas fa-camera"></i>æ‹æ‘„ç…§ç‰‡</button><button id="uploadPhotoBtn"
                                        class="flex-1 bg-teal-500 text-white px-4 py-3 rounded-full font-semibold flex items-center justify-center gap-2"><i
                                            class="fas fa-image"></i>ä»ç›¸å†Œé€‰æ‹©</button></div>
                            </div>
                            <div class="space-y-4">
                                <div><label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">éšæ‚£ç±»å‹</label><select
                                        id="hazardType"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                                        <option value="">è¯·é€‰æ‹©éšæ‚£ç±»å‹</option>
                                        <option value="æ¶ˆé˜²å®‰å…¨">æ¶ˆé˜²å®‰å…¨</option>
                                        <option value="ç”Ÿäº§å®‰å…¨">ç”Ÿäº§å®‰å…¨</option>
                                        <option value="ç”Ÿæ´»å®‰å…¨">ç”Ÿæ´»å®‰å…¨</option>
                                        <option value="äº¤é€šå®‰å…¨">äº¤é€šå®‰å…¨</option>
                                        <option value="é˜²ç¾å‡ç¾">é˜²ç¾å‡ç¾</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select></div>
                                <div><label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">éšæ‚£æè¿°</label><textarea
                                        id="hazardDesc" rows="4" placeholder="è¯·è¯¦ç»†æè¿°å‘ç°çš„å®‰å…¨éšæ‚£..."
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-none"></textarea>
                                </div>
                                <div><label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å±é™©ç­‰çº§</label>
                                    <div class="flex space-x-2"><button
                                            class="risk-btn flex-1 py-2 px-4 rounded-lg border-2 border-green-300 text-green-600 font-medium"
                                            data-level="low"><i
                                                class="fas fa-circle text-green-500 mr-1"></i>ä½é£é™©</button><button
                                            class="risk-btn flex-1 py-2 px-4 rounded-lg border-2 border-yellow-300 text-yellow-600 font-medium"
                                            data-level="medium"><i
                                                class="fas fa-circle text-yellow-500 mr-1"></i>ä¸­é£é™©</button><button
                                            class="risk-btn flex-1 py-2 px-4 rounded-lg border-2 border-red-300 text-red-600 font-medium"
                                            data-level="high"><i
                                                class="fas fa-circle text-red-500 mr-1"></i>é«˜é£é™©</button></div>
                                </div><button id="submitReport"
                                    class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg font-semibold mt-6"><i
                                        class="fas fa-paper-plane mr-2"></i>æäº¤æŠ¥å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ–°çš„æµ‹è¯•é¡µé¢ -->
            <section id="quiz" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <!-- æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
                        <div id="quizModeSelection" class="space-y-6">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">å®‰å…¨çŸ¥è¯†æŒ‘æˆ˜</h2>
                                <p class="text-gray-600 dark:text-gray-400">é€‰æ‹©ä½ çš„æŒ‘æˆ˜æ¨¡å¼</p>
                            </div>

                            <!-- ä¸ªäººç»Ÿè®¡å¡ç‰‡ -->
                            <div
                                class="bg-gradient-to-r from-primary to-secondary text-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-bold mb-4 flex items-center">
                                    <i class="fas fa-trophy mr-2"></i>æˆ‘çš„æˆ˜ç»©
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" id="totalStars">0</div>
                                        <div class="text-xs opacity-90">ç´¯è®¡â­</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" id="bestStreak">0</div>
                                        <div class="text-xs opacity-90">æœ€ä½³è¿èƒœ</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" id="fastestTime">--</div>
                                        <div class="text-xs opacity-90">æœ€å¿«è®°å½•</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" id="totalQuizzes">0</div>
                                        <div class="text-xs opacity-90">æµ‹è¯•æ¬¡æ•°</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æŒ‘æˆ˜æ¨¡å¼é€‰æ‹© -->
                            <div class="space-y-4">
                                <!-- ç«é€Ÿæ¨¡å¼ -->
                                <div class="quiz-mode-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg card-hover cursor-pointer"
                                    data-mode="speed">
                                    <div class="flex items-center">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-r from-red-400 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                                            <i class="fas fa-bolt text-white text-2xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">ç«é€ŸæŒ‘æˆ˜
                                            </h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">å¿«é€Ÿç­”é¢˜ï¼ŒæŒ‘æˆ˜é€Ÿåº¦æé™</p>
                                            <div class="flex items-center">
                                                <span
                                                    class="bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 px-2 py-1 rounded-full text-xs mr-2">âš¡
                                                    è®¡æ—¶æ¨¡å¼</span>
                                                <span class="text-yellow-500">â­ +3</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- é—¯å…³æ¨¡å¼ -->
                                <div class="quiz-mode-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg card-hover cursor-pointer"
                                    data-mode="challenge">
                                    <div class="flex items-center">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-r from-purple-400 to-indigo-500 rounded-xl flex items-center justify-center mr-4">
                                            <i class="fas fa-mountain text-white text-2xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">é—¯å…³æŒ‘æˆ˜
                                            </h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">è¿ç»­ç­”å¯¹ï¼Œè¿‡å…³æ–©å°†</p>
                                            <div class="flex items-center">
                                                <span
                                                    class="bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-2 py-1 rounded-full text-xs mr-2">ğŸ”ï¸
                                                    é€’è¿›éš¾åº¦</span>
                                                <span class="text-yellow-500">â­ +5</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- é™æ—¶æŒ‘æˆ˜ -->
                                <div class="quiz-mode-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg card-hover cursor-pointer"
                                    data-mode="timed">
                                    <div class="flex items-center">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-r from-orange-400 to-red-500 rounded-xl flex items-center justify-center mr-4">
                                            <i class="fas fa-stopwatch text-white text-2xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">é™æ—¶å¯¹æˆ˜
                                            </h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">æ¯é¢˜é™æ—¶ï¼Œç´§å¼ åˆºæ¿€</p>
                                            <div class="flex items-center">
                                                <span
                                                    class="bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 px-2 py-1 rounded-full text-xs mr-2">â°
                                                    å€’è®¡æ—¶</span>
                                                <span class="text-yellow-500">â­ +4</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>



                                <!-- ç»å…¸æ¨¡å¼ -->
                                <div class="quiz-mode-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg card-hover cursor-pointer"
                                    data-mode="classic">
                                    <div class="flex items-center">
                                        <div
                                            class="w-16 h-16 bg-gradient-to-r from-blue-400 to-cyan-500 rounded-xl flex items-center justify-center mr-4">
                                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">ç»å…¸æ¨¡å¼
                                            </h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">ç¨³æ‰ç¨³æ‰“ï¼ŒåŸºç¡€ç»ƒä¹ </p>
                                            <div class="flex items-center">
                                                <span
                                                    class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded-full text-xs mr-2">ğŸ“–
                                                    åŸºç¡€ç»ƒä¹ </span>
                                                <span class="text-yellow-500">â­ +2</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- æ’è¡Œæ¦œæŒ‰é’® -->
                            <div class="text-center">
                                <button id="showLeaderboard"
                                    class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all">
                                    <i class="fas fa-crown mr-2"></i>æŸ¥çœ‹æ’è¡Œæ¦œ
                                </button>
                            </div>
                        </div>

                        <!-- ç­”é¢˜ç•Œé¢ -->
                        <div id="quizGameInterface" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                                <div id="quizHeader" class="mb-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <button id="backToModes"
                                            class="text-gray-600 dark:text-gray-400 hover:text-primary">
                                            <i class="fas fa-arrow-left mr-2"></i>è¿”å›
                                        </button>
                                        <h3 id="currentModeTitle"
                                            class="text-lg font-bold text-gray-800 dark:text-white"></h3>
                                        <div class="w-8"></div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-4 text-center text-sm mb-4">
                                        <div>
                                            <span class="text-primary">é¢˜ç›®</span>
                                            <div><span id="currentQ">1</span>/<span id="totalQ">5</span></div>
                                        </div>
                                        <div>
                                            <span class="text-success">å¾—åˆ†</span>
                                            <div id="score">0</div>
                                        </div>
                                        <div id="timerContainer" class="hidden">
                                            <span class="text-warning">æ—¶é—´</span>
                                            <div id="timer" class="font-bold">30s</div>
                                        </div>
                                        <div id="streakContainer" class="hidden">
                                            <span class="text-purple-600">è¿èƒœ</span>
                                            <div id="streak">0</div>
                                        </div>
                                        <div id="totalTimeContainer" class="hidden">
                                            <span class="text-blue-600">æ€»æ—¶é—´</span>
                                            <div id="totalTime" class="font-bold">0s</div>
                                        </div>
                                    </div>

                                    <!-- è¿›åº¦æ¡ -->
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                                        <div id="progressBar"
                                            class="bg-gradient-to-r from-primary to-secondary h-2 rounded-full transition-all duration-300"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="quizContent"></div>
                            </div>
                        </div>

                        <!-- æ’è¡Œæ¦œç•Œé¢ -->
                        <div id="leaderboardInterface" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <button id="backFromLeaderboard"
                                        class="text-gray-600 dark:text-gray-400 hover:text-primary">
                                        <i class="fas fa-arrow-left mr-2"></i>è¿”å›
                                    </button>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">å†å²æ’è¡Œæ¦œ</h3>
                                    <button id="clearStatsBtn"
                                        class="text-red-600 dark:text-red-400 hover:text-red-700 text-sm">
                                        <i class="fas fa-trash mr-1"></i>æ¸…ç©º
                                    </button>
                                </div>
                                <div id="leaderboardContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cases" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">å®‰å…¨æ¡ˆä¾‹åº“</h2>
                        <div class="relative mb-4"><input type="search" id="casesSearch" placeholder="æœç´¢æ¡ˆä¾‹..."
                                class="w-full p-3 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base"><i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                        <div class="space-y-4" id="casesList"></div>
                        <div id="casesPagination" class="flex justify-center items-center flex-wrap gap-2 mt-6"></div>
                    </div>
                </div>
            </section>
            <section id="my-reports" class="page hidden">
                <div class="px-4 py-6">
                    <div class="max-w-md mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">æˆ‘çš„æŠ¥å‘Š</h2><button
                                id="addReportBtn"
                                class="bg-primary text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2"><i
                                    class="fas fa-plus"></i>æ–°å¢æŠ¥å‘Š</button>
                        </div>
                        <div class="space-y-4" id="myReportsList"></div>
                    </div>
                </div>
            </section>
        </main>

        <nav
            class="glass-effect fixed bottom-0 left-0 right-0 z-50 border-t border-gray-200/50 dark:border-gray-700/50">
            <div class="max-w-md mx-auto px-2 py-2">
                <div class="flex justify-around">
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="home"><i
                            class="fas fa-home text-xl mb-1"></i><span class="text-xs">é¦–é¡µ</span></button>
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="capture"><i
                            class="fas fa-camera text-xl mb-1"></i><span class="text-xs">æ‹ç…§</span></button>
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="my-reports"><i
                            class="fas fa-user-check text-xl mb-1"></i><span class="text-xs">æŠ¥å‘Š</span></button>
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="learning"><i
                            class="fas fa-graduation-cap text-xl mb-1"></i><span class="text-xs">å­¦ä¹ </span></button>
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="quiz"><i
                            class="fas fa-question-circle text-xl mb-1"></i><span class="text-xs">æµ‹è¯•</span></button>
                    <button class="nav-btn flex flex-col items-center py-2 px-3 rounded-lg" data-page="cases"><i
                            class="fas fa-clipboard-list text-xl mb-1"></i><span class="text-xs">æ¡ˆä¾‹</span></button>
                </div>
            </div>
        </nav>

        <div id="successModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99] hidden">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl max-w-sm w-full mx-4 text-center">
                <div
                    class="w-16 h-16 bg-gradient-to-r from-success to-accent rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h3 id="successModalTitle" class="text-xl font-bold text-gray-800 dark:text-white mb-2">æ“ä½œæˆåŠŸï¼</h3>
                <p id="successModalMessage" class="text-gray-600 dark:text-gray-400 mb-6">æ‚¨çš„æ“ä½œå·²æˆåŠŸå®Œæˆã€‚</p><button
                    id="closeModal"
                    class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-lg font-semibold">ç¡®å®š</button>
            </div>
        </div>
        <div id="deleteConfirmModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99] hidden">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl max-w-sm w-full mx-4 text-center">
                <div
                    class="w-16 h-16 bg-gradient-to-r from-warning to-secondary rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">ç¡®è®¤åˆ é™¤</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä»½æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                <div class="flex gap-4"><button id="cancelDeleteBtn"
                        class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-6 py-2 rounded-lg font-semibold">å–æ¶ˆ</button><button
                        id="confirmDeleteBtn"
                        class="flex-1 bg-secondary text-white px-6 py-2 rounded-lg font-semibold">åˆ é™¤</button></div>
            </div>
        </div>
        <div id="cameraModal"
            class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center z-[101] hidden"><video
                id="cameraVideo" class="w-full h-auto max-h-[80vh]"></video>
            <div class="absolute bottom-10 flex items-center gap-8"><button id="closeCameraBtn"
                    class="w-16 h-16 bg-white/30 rounded-full text-white flex items-center justify-center"><i
                        class="fas fa-times fa-lg"></i></button><button id="snapBtn"
                    class="w-20 h-20 bg-white rounded-full border-4 border-gray-300"></button>
                <div class="w-16 h-16"></div>
            </div><canvas id="cameraCanvas" class="hidden"></canvas>
        </div>
    </div>

    <script>
        let knowledgeData = [], fullQuizData = [], casesData = [], marineEducationData = [];
        let currentPage = 'home', editingReportId = null, reportToDeleteId = null, selectedRiskLevel = '';
        let currentQuizSession = [], currentQuizIndex = 0, quizScore = 0;
        const ITEMS_PER_PAGE = 5;
        let knowledgeCurrentPage = 1, casesCurrentPage = 1, marineCurrentPage = 1, filteredKnowledge = [], filteredCases = [], filteredMarine = [];
        let cameraStream = null;

        // æ–°å¢æµ‹è¯•ç›¸å…³å˜é‡
        let currentQuizMode = 'classic';
        let quizTimer = null;
        let totalTimeTimer = null;
        let quizStartTime = 0;
        let currentStreak = 0;
        let quizTimeLimit = 30;

        const pageTitles = {
            home: 'å®‰å…¨éšæ‚£éšæ‰‹æ‹', learning: 'å®‰å…¨å­¦ä¹ ä¸­å¿ƒ', knowledge: 'å®‰å…¨çŸ¥è¯†åº“', 'marine-safety': 'æµ·æ´‹å®‰å…¨æ•™è‚²',
            capture: 'éšæ‚£æŠ¥å‘Š', quiz: 'å®‰å…¨çŸ¥è¯†æµ‹è¯•', cases: 'å®‰å…¨æ¡ˆä¾‹åº“', 'my-reports': 'æˆ‘çš„æŠ¥å‘Š'
        };

        // æµ‹è¯•æ¨¡å¼é…ç½®
        const quizModes = {
            classic: { name: 'ç»å…¸æ¨¡å¼', questionCount: 10, timeLimit: 0, stars: 2 },
            speed: { name: 'ç«é€ŸæŒ‘æˆ˜', questionCount: 10, timeLimit: 0, stars: 3 },
            timed: { name: 'é™æ—¶å¯¹æˆ˜', questionCount: 10, timeLimit: 20, stars: 4 },
            challenge: { name: 'é—¯å…³æŒ‘æˆ˜', questionCount: 10, timeLimit: 0, stars: 5 }
        };

        async function loadAllData() {
            try {
                const [knowledgeRes, quizRes, casesRes, marineRes] = await Promise.all([
                    fetch('data/knowledge_base.txt'),
                    fetch('data/quiz_base.txt'),
                    fetch('data/cases_base.txt'),
                    fetch('data/marine_education.txt')
                ]);
                if (!knowledgeRes.ok || !quizRes.ok || !casesRes.ok || !marineRes.ok) throw new Error('Network response was not ok.');
                knowledgeData = await knowledgeRes.json();
                fullQuizData = await quizRes.json();
                casesData = await casesRes.json();
                marineEducationData = await marineRes.json();
                filteredKnowledge = [...knowledgeData];
                filteredCases = [...casesData];
                filteredMarine = [...marineEducationData];
                return true;
            } catch (error) {
                console.error("åŠ è½½æ•°æ®æ–‡ä»¶å¤±è´¥:", error);
                const loader = document.getElementById('loader');
                loader.innerHTML = `<div class="text-center text-red-500 p-4"><p class="font-bold">æ•°æ®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼</p><p class="text-sm mt-2">è¯·ç¡®ä¿æ‚¨æ˜¯é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ (http://) è®¿é—®ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰“å¼€æ–‡ä»¶ (file://)ã€‚</p><p class="text-sm mt-1">åŒæ—¶è¯·æ£€æŸ¥ 'data' æ–‡ä»¶å¤¹åŠå†…éƒ¨çš„ .txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”è·¯å¾„æ­£ç¡®ã€‚</p></div>`;
                return false;
            }
        }

        function isMobileDevice() { return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            toast.className = `fixed top-5 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-[102] animate-toast-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('animate-toast-in');
                toast.classList.add('animate-toast-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function setPageTitle(pageId) { document.getElementById('pageTitle').textContent = pageTitles[pageId] || 'å®‰å…¨éšæ‚£éšæ‰‹æ‹'; }

        function showPage(pageId, reportIdToEdit = null) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const newPage = document.getElementById(pageId);
            if (newPage) newPage.classList.remove('hidden');
            currentPage = pageId;
            setPageTitle(pageId);
            updateNavigation();
            window.scrollTo(0, 0);

            if (pageId === 'capture') {
                handleCapturePageLoad(reportIdToEdit);
            } else {
                editingReportId = null;
                const pageInitializers = {
                    knowledge: initKnowledgePage,
                    quiz: initQuizPage,
                    cases: initCasesPage,
                    'marine-safety': initMarinePage,
                    'my-reports': renderMyReports
                };
                if (pageInitializers[pageId]) pageInitializers[pageId]();
            }
        }

        function initKnowledgePage() { filteredKnowledge = [...knowledgeData]; knowledgeCurrentPage = 1; document.getElementById('knowledgeSearch').value = ''; renderPaginatedKnowledge(); }
        function initCasesPage() { filteredCases = [...casesData]; casesCurrentPage = 1; document.getElementById('casesSearch').value = ''; renderPaginatedCases(); }
        function initMarinePage() { filteredMarine = [...marineEducationData]; marineCurrentPage = 1; document.getElementById('marineSearch').value = ''; renderPaginatedMarine(); }

        // æ–°çš„æµ‹è¯•åˆå§‹åŒ–å‡½æ•°
        function initQuizPage() {
            showQuizModeSelection();
            loadQuizStats();
        }

        function showQuizModeSelection() {
            document.getElementById('quizModeSelection').classList.remove('hidden');
            document.getElementById('quizGameInterface').classList.add('hidden');
            document.getElementById('leaderboardInterface').classList.add('hidden');
        }

        function showQuizGameInterface() {
            document.getElementById('quizModeSelection').classList.add('hidden');
            document.getElementById('quizGameInterface').classList.remove('hidden');
            document.getElementById('leaderboardInterface').classList.add('hidden');
        }

        function showLeaderboardInterface() {
            document.getElementById('quizModeSelection').classList.add('hidden');
            document.getElementById('quizGameInterface').classList.add('hidden');
            document.getElementById('leaderboardInterface').classList.remove('hidden');
            renderLeaderboard();
        }

        function loadQuizStats() {
            const stats = JSON.parse(localStorage.getItem('quizStats')) || {
                totalStars: 0,
                bestStreak: 0,
                fastestTime: null,
                totalQuizzes: 0,
                records: []
            };

            document.getElementById('totalStars').textContent = stats.totalStars;
            document.getElementById('bestStreak').textContent = stats.bestStreak;
            document.getElementById('fastestTime').textContent = stats.fastestTime ? `${stats.fastestTime}s` : '--';
            document.getElementById('totalQuizzes').textContent = stats.totalQuizzes;
        }

        function saveQuizStats(newRecord) {
            const stats = JSON.parse(localStorage.getItem('quizStats')) || {
                totalStars: 0,
                bestStreak: 0,
                fastestTime: null,
                totalQuizzes: 0,
                records: []
            };

            stats.totalStars += newRecord.stars;
            stats.bestStreak = Math.max(stats.bestStreak, newRecord.streak);
            stats.totalQuizzes++;

            if (newRecord.mode === 'speed' && newRecord.totalTime > 0) {
                if (!stats.fastestTime || newRecord.totalTime < stats.fastestTime) {
                    stats.fastestTime = newRecord.totalTime;
                }
            }

            stats.records.push({
                ...newRecord,
                timestamp: Date.now()
            });

            // åªä¿ç•™æœ€è¿‘100æ¬¡è®°å½•
            if (stats.records.length > 100) {
                stats.records = stats.records.slice(-100);
            }

            localStorage.setItem('quizStats', JSON.stringify(stats));
            loadQuizStats();
        }

        function clearAllStats() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æˆ˜ç»©å’Œæ’è¡Œæ¦œæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('quizStats');
                loadQuizStats();
                renderLeaderboard();
                showToast('æˆ˜ç»©å’Œæ’è¡Œæ¦œå·²æ¸…ç©º');
            }
        }

        function startQuizMode(mode) {
            if (fullQuizData.length === 0) {
                showToast('é¢˜åº“åŠ è½½å¤±è´¥ï¼Œæ— æ³•å¼€å§‹æµ‹è¯•ã€‚');
                return;
            }

            currentQuizMode = mode;
            const modeConfig = quizModes[mode];



            const shuffled = [...fullQuizData].sort(() => 0.5 - Math.random());
            currentQuizSession = shuffled.slice(0, modeConfig.questionCount);
            currentQuizIndex = 0;
            quizScore = 0;
            currentStreak = 0;
            quizStartTime = Date.now();

            document.getElementById('currentModeTitle').textContent = modeConfig.name;
            document.getElementById('totalQ').textContent = currentQuizSession.length;

            // ç¡®ä¿æ¸¸æˆå¤´éƒ¨æ˜¾ç¤º
            document.getElementById('quizHeader').style.display = 'block';

            // æ˜¾ç¤º/éšè—ç›¸å…³å…ƒç´ 
            const timerContainer = document.getElementById('timerContainer');
            const streakContainer = document.getElementById('streakContainer');
            const totalTimeContainer = document.getElementById('totalTimeContainer');

            if (modeConfig.timeLimit > 0) {
                timerContainer.classList.remove('hidden');
                quizTimeLimit = modeConfig.timeLimit;
            } else {
                timerContainer.classList.add('hidden');
            }

            if (mode === 'challenge') {
                streakContainer.classList.remove('hidden');
            } else {
                streakContainer.classList.add('hidden');
            }

            if (mode === 'speed') {
                totalTimeContainer.classList.remove('hidden');
                // å¯åŠ¨æ€»æ—¶é—´è®¡æ—¶å™¨
                if (totalTimeTimer) clearInterval(totalTimeTimer);
                totalTimeTimer = setInterval(() => {
                    const totalTimeEl = document.getElementById('totalTime');
                    if (totalTimeEl) {
                        const elapsed = Math.round((Date.now() - quizStartTime) / 1000);
                        totalTimeEl.textContent = `${elapsed}s`;
                    }
                }, 1000);
            } else {
                totalTimeContainer.classList.add('hidden');
                if (totalTimeTimer) {
                    clearInterval(totalTimeTimer);
                    totalTimeTimer = null;
                }
            }

            showQuizGameInterface();
            updateQuizDisplay();
        }

        function updateQuizDisplay() {
            const content = document.getElementById('quizContent');
            const currentEl = document.getElementById('currentQ');
            const scoreEl = document.getElementById('score');
            const progressBar = document.getElementById('progressBar');
            const streakEl = document.getElementById('streak');
            const totalTimeEl = document.getElementById('totalTime');

            currentEl.textContent = currentQuizIndex + 1;
            scoreEl.textContent = quizScore;
            streakEl.textContent = currentStreak;

            // æ›´æ–°æ€»æ—¶é—´æ˜¾ç¤ºï¼ˆç«é€Ÿæ¨¡å¼ï¼‰
            if (currentQuizMode === 'speed' && totalTimeEl) {
                const elapsed = Math.round((Date.now() - quizStartTime) / 1000);
                totalTimeEl.textContent = `${elapsed}s`;
            }

            const progress = ((currentQuizIndex + 1) / currentQuizSession.length) * 100;
            progressBar.style.width = `${progress}%`;

            if (currentQuizIndex < currentQuizSession.length) {
                const quiz = currentQuizSession[currentQuizIndex];

                content.innerHTML = `
                    <div class="animate-slide-up">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                            ${currentQuizIndex + 1}. ${quiz.question}
                        </h3>
                        <div class="space-y-3">
                            ${quiz.options.map((option, index) => `
                                <button class="quiz-option w-full p-3 text-left border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-primary transition-colors" data-index="${index}">
                                    <span class="font-medium">${String.fromCharCode(65 + index)}.</span> ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;

                // å¯åŠ¨è®¡æ—¶å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (quizModes[currentQuizMode].timeLimit > 0) {
                    startQuestionTimer();
                }

                content.querySelectorAll('.quiz-option').forEach(btn =>
                    btn.addEventListener('click', function () {
                        handleQuizAnswer(parseInt(this.dataset.index));
                    })
                );
            } else {
                finishQuiz();
            }
        }

        function startQuestionTimer() {
            const timerEl = document.getElementById('timer');
            let timeLeft = quizTimeLimit;

            if (quizTimer) clearInterval(quizTimer);

            quizTimer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `${timeLeft}s`;

                if (timeLeft <= 5) {
                    timerEl.classList.add('text-red-500');
                }

                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    handleQuizAnswer(-1); // è¶…æ—¶è§†ä¸ºç­”é”™
                }
            }, 1000);
        }

        function handleQuizAnswer(selectedIndex) {
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }

            const quiz = currentQuizSession[currentQuizIndex];
            const isCorrect = selectedIndex === quiz.correct;
            const content = document.getElementById('quizContent');

            // æ˜¾ç¤ºç­”æ¡ˆåé¦ˆ
            content.querySelectorAll('.quiz-option').forEach((optionBtn, idx) => {
                optionBtn.disabled = true;
                optionBtn.classList.remove('hover:border-primary');

                if (idx === quiz.correct) {
                    optionBtn.classList.add('border-success', 'bg-green-50', 'dark:bg-green-900/50', 'text-green-700', 'dark:text-green-300');
                } else if (idx === selectedIndex && selectedIndex !== -1) {
                    optionBtn.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/50', 'text-red-700', 'dark:text-red-300');
                }
            });

            // æ›´æ–°åˆ†æ•°å’Œè¿èƒœ
            if (isCorrect) {
                const baseScore = 20;
                const timeBonus = currentQuizMode === 'speed' ? 5 : 0;
                const streakBonus = currentQuizMode === 'challenge' ? currentStreak * 2 : 0;

                quizScore += baseScore + timeBonus + streakBonus;
                currentStreak++;
            } else {
                if (currentQuizMode === 'challenge') {
                    currentStreak = 0;
                }
            }

            document.getElementById('score').textContent = quizScore;
            document.getElementById('streak').textContent = currentStreak;

            setTimeout(() => {
                currentQuizIndex++;
                updateQuizDisplay();
            }, 1500);
        }

        function finishQuiz() {
            // æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            if (totalTimeTimer) {
                clearInterval(totalTimeTimer);
                totalTimeTimer = null;
            }

            const totalTime = Math.round((Date.now() - quizStartTime) / 1000);
            const modeConfig = quizModes[currentQuizMode];
            const percentage = Math.round((quizScore / (currentQuizSession.length * 20)) * 100);

            let starsEarned = 0;
            if (percentage >= 80) starsEarned = modeConfig.stars;
            else if (percentage >= 60) starsEarned = Math.floor(modeConfig.stars * 0.7);
            else if (percentage >= 40) starsEarned = Math.floor(modeConfig.stars * 0.4);

            // ä¿å­˜è®°å½•
            const record = {
                mode: currentQuizMode,
                score: quizScore,
                percentage: percentage,
                streak: currentStreak,
                totalTime: totalTime,
                stars: starsEarned,
                questionCount: currentQuizSession.length
            };

            saveQuizStats(record);



            // æ˜¾ç¤ºå®Œæˆç•Œé¢
            document.getElementById('quizHeader').style.display = 'none';
            const content = document.getElementById('quizContent');

            let message = '';
            if (percentage >= 80) message = 'å¤ªæ£’äº†ï¼æ‚¨æ˜¯å®‰å…¨è¾¾äººï¼';
            else if (percentage >= 60) message = 'ä¸é”™ï¼å®‰å…¨æ„è¯†è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒï¼';
            else message = 'ä»éœ€åŠªåŠ›ï¼å»ºè®®å¤šæµè§ˆçŸ¥è¯†åº“å’Œæ¡ˆä¾‹åº“åŠ å¼ºå­¦ä¹ ã€‚';

            content.innerHTML = `
                <div class="text-center animate-slide-up">
                    <div class="w-20 h-20 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-trophy text-white text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">æŒ‘æˆ˜å®Œæˆï¼</h3>
                    <div class="space-y-2 mb-4">
                        <p class="text-lg text-primary font-semibold">å¾—åˆ†ï¼š${quizScore} åˆ† (${percentage}%)</p>
                        <p class="text-lg text-yellow-500 font-semibold">è·å¾— ${starsEarned} â­</p>
                        ${currentQuizMode === 'speed' ? `
                            <p class="text-sm text-gray-600 dark:text-gray-400">æ€»ç”¨æ—¶ï¼š${totalTime}ç§’</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">å¹³å‡æ¯é¢˜ï¼š${Math.round(totalTime / currentQuizSession.length)}ç§’</p>
                        ` : ''}
                        ${currentQuizMode === 'timed' ? `<p class="text-sm text-gray-600 dark:text-gray-400">é™æ—¶æŒ‘æˆ˜å®Œæˆï¼</p>` : ''}
                        ${currentQuizMode === 'challenge' ? `<p class="text-sm text-gray-600 dark:text-gray-400">æœ€é«˜è¿èƒœï¼š${currentStreak}</p>` : ''}
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button id="restartQuiz" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-4 py-3 rounded-lg font-semibold">
                            å†æ¥ä¸€æ¬¡
                        </button>
                        <button id="backToModeSelection" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-4 py-3 rounded-lg font-semibold">
                            é€‰æ‹©æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('restartQuiz').addEventListener('click', () => startQuizMode(currentQuizMode));
            document.getElementById('backToModeSelection').addEventListener('click', showQuizModeSelection);
        }

        function renderLeaderboard() {
            const stats = JSON.parse(localStorage.getItem('quizStats')) || { records: [] };
            const records = stats.records.slice().reverse(); // æœ€æ–°çš„åœ¨å‰
            const content = document.getElementById('leaderboardContent');

            if (records.length === 0) {
                content.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 p-8">
                        <i class="fas fa-trophy fa-3x mb-4 opacity-50"></i>
                        <p>è¿˜æ²¡æœ‰æŒ‘æˆ˜è®°å½•</p>
                        <p class="text-sm mt-2">å¿«å»å®Œæˆä¸€äº›æµ‹è¯•å§ï¼</p>
                    </div>
                `;
                return;
            }

            const groupedRecords = {};
            records.forEach(record => {
                if (!groupedRecords[record.mode]) {
                    groupedRecords[record.mode] = [];
                }
                groupedRecords[record.mode].push(record);
            });

            let html = '';
            Object.keys(groupedRecords).forEach(mode => {
                const modeRecords = groupedRecords[mode].slice(0, 5); // åªæ˜¾ç¤ºå‰5æ¡
                const modeConfig = quizModes[mode];

                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-3 flex items-center">
                            <i class="fas fa-medal mr-2 text-yellow-500"></i>
                            ${modeConfig.name}
                        </h4>
                        <div class="space-y-2">
                `;

                modeRecords.forEach((record, index) => {
                    const date = new Date(record.timestamp).toLocaleDateString('zh-CN');
                    const rankColors = ['text-yellow-500', 'text-gray-400', 'text-orange-500'];
                    const rankColor = rankColors[index] || 'text-gray-600';

                    html += `
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="${rankColor} font-bold mr-3">#${index + 1}</span>
                                <div>
                                    <div class="font-semibold">${record.score}åˆ† (${record.percentage}%)</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${date}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-500 font-bold">${record.stars}â­</div>
                                ${record.totalTime ? `<div class="text-xs text-gray-500">${record.totalTime}s</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function updateNavigation() {
            const navContainer = document.querySelector('.flex.justify-around');
            if (!navContainer) return;
            navContainer.querySelectorAll('.nav-btn').forEach(btn => {
                const isDark = document.documentElement.classList.contains('dark');
                btn.classList.toggle('text-primary', btn.dataset.page === currentPage);
                btn.classList.toggle('text-gray-500', btn.dataset.page !== currentPage);
                if (isDark) {
                    btn.classList.toggle('dark:text-gray-400', btn.dataset.page !== currentPage);
                }
            });
        }

        function renderMyReports() {
            const container = document.getElementById('myReportsList');
            container.innerHTML = '';
            const reports = JSON.parse(localStorage.getItem('safetyReports')) || [];
            if (reports.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg"><i class="fas fa-folder-open fa-3x mb-4"></i><p>æ‚¨è¿˜æ²¡æœ‰æäº¤ä»»ä½•æŠ¥å‘Šã€‚</p><p class="text-sm mt-2">ç‚¹å‡»ä¸Šæ–¹çš„"æ–°å¢æŠ¥å‘Š"æˆ–åº•éƒ¨å¯¼èˆªçš„"æ‹ç…§"æ¥åˆ›å»ºå§ï¼</p></div>`;
                return;
            }
            reports.slice().reverse().forEach(report => {
                const riskStyles = { low: { text: 'ä½é£é™©', classes: 'border-green-500 text-green-600' }, medium: { text: 'ä¸­é£é™©', classes: 'border-yellow-500 text-yellow-600' }, high: { text: 'é«˜é£é™©', classes: 'border-red-500 text-red-600' } };
                const risk = riskStyles[report.riskLevel] || { text: 'æœªçŸ¥', classes: 'border-gray-500' };
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 animate-slide-up';
                card.innerHTML = `<div class="flex gap-4"><img src="${report.imageData}" class="w-24 h-24 object-cover rounded-lg flex-shrink-0"><div class="flex-grow flex flex-col justify-between"><div><div class="flex justify-between items-start mb-1"><span class="bg-primary/10 text-primary px-2 py-1 rounded-full text-xs font-medium">${report.type || 'å…¶ä»–éšæ‚£'}</span><span class="px-3 py-1 text-xs font-semibold rounded-full border-2 ${risk.classes}">${risk.text}</span></div><p class="text-sm text-gray-700 dark:text-gray-300 my-2">${report.description}</p></div><div class="flex justify-between items-center mt-2"><span class="text-xs text-gray-400">${new Date(report.timestamp).toLocaleString('zh-CN', { hour12: false })}</span><div class="flex gap-2"><button class="edit-btn text-sm text-blue-500 hover:text-blue-700" data-id="${report.id}"><i class="fas fa-edit mr-1"></i>ç¼–è¾‘</button><button class="delete-btn text-sm text-red-500 hover:text-red-700" data-id="${report.id}"><i class="fas fa-trash-alt mr-1"></i>åˆ é™¤</button></div></div></div></div>`;
                container.appendChild(card);
            });
        }

        function handleCapturePageLoad(reportId) {
            resetCaptureForm();
            if (reportId) {
                editingReportId = reportId;
                const reports = JSON.parse(localStorage.getItem('safetyReports')) || [];
                const reportToEdit = reports.find(r => r.id == editingReportId);
                if (reportToEdit) {
                    document.getElementById('captureTitle').textContent = 'ç¼–è¾‘éšæ‚£æŠ¥å‘Š';
                    document.getElementById('submitReport').innerHTML = `<i class="fas fa-save mr-2"></i>æ›´æ–°æŠ¥å‘Š`;
                    populateCaptureForm(reportToEdit);
                }
            } else {
                editingReportId = null;
                document.getElementById('captureTitle').textContent = 'æ–°å¢éšæ‚£æŠ¥å‘Š';
                document.getElementById('submitReport').innerHTML = `<i class="fas fa-paper-plane mr-2"></i>æäº¤æŠ¥å‘Š`;
            }
        }

        function populateCaptureForm(report) {
            document.getElementById('reportId').value = report.id;
            document.getElementById('hazardType').value = report.type;
            document.getElementById('hazardDesc').value = report.description;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${report.imageData}" class="w-full h-full object-cover rounded-2xl">`;
            preview.dataset.imageData = report.imageData;
            document.querySelectorAll('.risk-btn').forEach(btn => { if (btn.dataset.level === report.riskLevel) btn.click(); });
        }

        function showSuccessModal(title, message) {
            document.getElementById('successModalTitle').textContent = title;
            document.getElementById('successModalMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        function renderPaginationControls(containerId, currentPage, totalPages, pageChangeHandler) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            let allItemsHTML = `<button class="prev-btn w-10 h-10 rounded-lg bg-gray-200 dark:bg-gray-700 disabled:opacity-50 flex-shrink-0" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
            const maxPagesToShow = 3; let startPage, endPage;
            if (totalPages <= maxPagesToShow + 2) { startPage = 1; endPage = totalPages; }
            else {
                if (currentPage <= maxPagesToShow) { startPage = 1; endPage = maxPagesToShow + 1; }
                else if (currentPage + 1 >= totalPages) { startPage = totalPages - maxPagesToShow; endPage = totalPages; }
                else { startPage = currentPage - 1; endPage = currentPage + 1; }
            }
            if (startPage > 1) { allItemsHTML += `<button data-page="1" class="page-btn w-10 h-10 rounded-lg bg-gray-200 dark:bg-gray-700 flex-shrink-0">1</button>`; if (startPage > 2) allItemsHTML += `<span class="w-10 h-10 flex items-center justify-center flex-shrink-0">...</span>`; }
            for (let i = startPage; i <= endPage; i++) { allItemsHTML += `<button data-page="${i}" class="page-btn w-10 h-10 rounded-lg ${currentPage === i ? 'bg-primary text-white font-bold' : 'bg-gray-200 dark:bg-gray-700'} flex-shrink-0">${i}</button>`; }
            if (endPage < totalPages) { if (endPage < totalPages - 1) allItemsHTML += `<span class="w-10 h-10 flex items-center justify-center flex-shrink-0">...</span>`; allItemsHTML += `<button data-page="${totalPages}" class="page-btn w-10 h-10 rounded-lg bg-gray-200 dark:bg-gray-700 flex-shrink-0">${totalPages}</button>`; }
            allItemsHTML += `<div class="flex items-center gap-1 ml-2"><input type="number" id="${containerId}-jump" class="w-16 text-center border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-md p-2" min="1" max="${totalPages}" placeholder="é¡µç "><button id="${containerId}-jump-btn" class="px-3 py-2 bg-primary text-white text-sm rounded-md">è·³è½¬</button></div>`;
            allItemsHTML += `<button class="next-btn w-10 h-10 rounded-lg bg-gray-200 dark:bg-gray-700 disabled:opacity-50 flex-shrink-0" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
            container.innerHTML = allItemsHTML;

            container.querySelector('.prev-btn')?.addEventListener('click', () => pageChangeHandler(currentPage - 1));
            container.querySelector('.next-btn')?.addEventListener('click', () => pageChangeHandler(currentPage + 1));
            container.querySelectorAll('.page-btn').forEach(btn => btn.addEventListener('click', (e) => pageChangeHandler(parseInt(e.currentTarget.dataset.page))));
            const jumpBtn = document.getElementById(`${containerId}-jump-btn`), jumpInput = document.getElementById(`${containerId}-jump`);
            jumpBtn?.addEventListener('click', () => { const pageNum = parseInt(jumpInput.value); if (pageNum >= 1 && pageNum <= totalPages) pageChangeHandler(pageNum); });
            jumpInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const pageNum = parseInt(jumpInput.value); if (pageNum >= 1 && pageNum <= totalPages) pageChangeHandler(pageNum); } });
        }

        function renderPaginatedKnowledge() {
            const container = document.getElementById('knowledgeCards'), totalPages = Math.ceil(filteredKnowledge.length / ITEMS_PER_PAGE) || 1;
            container.innerHTML = '';
            const paginatedItems = filteredKnowledge.slice((knowledgeCurrentPage - 1) * ITEMS_PER_PAGE, knowledgeCurrentPage * ITEMS_PER_PAGE);
            paginatedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 card-hover animate-slide-up';
                card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="text-lg font-semibold text-gray-800 dark:text-white">${item.title}</h3><span class="bg-primary/10 text-primary px-2 py-1 rounded-full text-xs font-medium flex-shrink-0 ml-2">${item.category}</span></div><p class="text-gray-600 dark:text-gray-400 text-sm">${item.content}</p>`;
                container.appendChild(card);
            });
            renderPaginationControls('knowledgePagination', knowledgeCurrentPage, totalPages, newPage => { knowledgeCurrentPage = newPage; renderPaginatedKnowledge(); window.scrollTo(0, 0); });
        }

        function renderPaginatedCases() {
            const container = document.getElementById('casesList'), totalPages = Math.ceil(filteredCases.length / ITEMS_PER_PAGE) || 1;
            container.innerHTML = '';
            const paginatedItems = filteredCases.slice((casesCurrentPage - 1) * ITEMS_PER_PAGE, casesCurrentPage * ITEMS_PER_PAGE);
            paginatedItems.forEach(caseItem => {
                const severityStyles = { low: { text: 'ä½é£é™©', classes: 'text-green-600 bg-green-100 dark:text-green-300 dark:bg-green-900/50' }, medium: { text: 'ä¸­é£é™©', classes: 'text-yellow-600 bg-yellow-100 dark:text-yellow-300 dark:bg-yellow-900/50' }, high: { text: 'é«˜é£é™©', classes: 'text-red-600 bg-red-100 dark:text-red-300 dark:bg-red-900/50' } };
                const severity = severityStyles[caseItem.severity] || severityStyles.low;
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 card-hover animate-slide-up';
                card.innerHTML = `<div class="flex justify-between items-start mb-3"><h3 class="text-lg font-semibold text-gray-800 dark:text-white">${caseItem.title}</h3><span class="px-2 py-1 rounded-full text-xs font-medium flex-shrink-0 ml-2 ${severity.classes}">${severity.text}</span></div><div class="flex items-center mb-3"><span class="bg-primary/10 text-primary px-2 py-1 rounded-full text-xs font-medium mr-2">${caseItem.type}</span><span class="text-gray-500 dark:text-gray-400 text-xs">${caseItem.date}</span></div><p class="text-gray-600 dark:text-gray-400 text-sm mb-3">${caseItem.description}</p><div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg"><p class="text-blue-800 dark:text-blue-300 text-sm"><i class="fas fa-lightbulb mr-2"></i><strong>ç»éªŒæ•™è®­ï¼š</strong>${caseItem.lesson}</p></div>`;
                container.appendChild(card);
            });
            renderPaginationControls('casesPagination', casesCurrentPage, totalPages, newPage => { casesCurrentPage = newPage; renderPaginatedCases(); window.scrollTo(0, 0); });
        }

        function renderPaginatedMarine() {
            const container = document.getElementById('marineCards'), totalPages = Math.ceil(filteredMarine.length / ITEMS_PER_PAGE) || 1;
            container.innerHTML = '';
            const paginatedItems = filteredMarine.slice((marineCurrentPage - 1) * ITEMS_PER_PAGE, marineCurrentPage * ITEMS_PER_PAGE);
            paginatedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 card-hover animate-slide-up';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${item.title}</h3>
                        <span class="bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-300 px-2 py-1 rounded-full text-xs font-medium flex-shrink-0 ml-2">${item.category}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-3">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span>${item.location}</span>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">${item.content}</p>
                    <div class="space-y-2">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>å®‰å…¨æç¤º
                        </h4>
                        <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                            ${item.tips.slice(0, 3).map(tip => `<li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-0.5 flex-shrink-0"></i><span>${tip}</span></li>`).join('')}
                        </ul>
                        ${item.tips.length > 3 ? `<button class="text-xs text-primary hover:text-primary/80 mt-2" onclick="showMarineDetail(${item.id})">æŸ¥çœ‹æ›´å¤š <i class="fas fa-chevron-right"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
            renderPaginationControls('marinePagination', marineCurrentPage, totalPages, newPage => { marineCurrentPage = newPage; renderPaginatedMarine(); window.scrollTo(0, 0); });
        }

        function showMarineDetail(id) {
            const item = marineEducationData.find(m => m.id === id);
            if (!item) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99] p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 p-6 border-b border-gray-200 dark:border-gray-700 rounded-t-2xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">${item.title}</h3>
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <span class="bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-300 px-2 py-1 rounded-full text-xs font-medium mr-2">${item.category}</span>
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${item.location}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>è¯¦ç»†ä»‹ç»
                            </h4>
                            <p class="text-gray-600 dark:text-gray-400 leading-relaxed">${item.content}</p>
                        </div>
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>å®‰å…¨æç¤º
                            </h4>
                            <ul class="space-y-2">
                                ${item.tips.map(tip => `<li class="flex items-start text-sm text-gray-600 dark:text-gray-400"><i class="fas fa-check text-green-500 mr-2 mt-0.5 flex-shrink-0"></i><span>${tip}</span></li>`).join('')}
                            </ul>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800">
                            <h4 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2 flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>åº”æ€¥å¤„ç†
                            </h4>
                            <p class="text-red-700 dark:text-red-300 text-sm leading-relaxed">${item.emergency}</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function resetCaptureForm() {
            document.getElementById('reportId').value = ''; document.getElementById('hazardType').value = ''; document.getElementById('hazardDesc').value = '';
            document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-red-100', 'dark:bg-green-900/50', 'dark:bg-yellow-900/50', 'dark:bg-red-900/50', 'font-bold'));
            document.getElementById('photoPreview').innerHTML = '<i class="fas fa-camera text-4xl text-gray-400"></i>';
            document.getElementById('mobileCameraInput').value = ''; document.getElementById('uploadInput').value = '';
            document.getElementById('photoPreview').dataset.imageData = ''; selectedRiskLevel = '';
        }

        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<div class="w-8 h-8 rounded-full animate-spin preview-spinner"></div>`;
            compressImage(file, 1024, 0.7).then(compressedImageData => {
                preview.innerHTML = `<img src="${compressedImageData}" class="w-full h-full object-cover rounded-2xl">`;
                preview.dataset.imageData = compressedImageData;
            }).catch(err => {
                showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                console.error(err);
                preview.innerHTML = '<i class="fas fa-camera text-4xl text-gray-400"></i>';
            });
        }

        function compressImage(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = e => {
                    img.src = e.target.result;
                    img.onload = () => {
                        getOrientation(file, orientation => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                            } else {
                                if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                            }
                            const ctx = canvas.getContext('2d');
                            if (orientation > 4) {
                                canvas.width = height; canvas.height = width;
                            } else { canvas.width = width; canvas.height = height; }
                            applyTransform(ctx, canvas.width, canvas.height, orientation);
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        });
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getOrientation(file, callback) {
            const reader = new FileReader();
            reader.onload = e => {
                const view = new DataView(e.target.result);
                if (view.getUint16(0, false) != 0xFFD8) return callback(-2);
                const length = view.byteLength; let offset = 2;
                while (offset < length) {
                    if (view.getUint16(offset + 2, false) <= 8) return callback(-1);
                    const marker = view.getUint16(offset, false);
                    offset += 2;
                    if (marker == 0xFFE1) {
                        if (view.getUint32(offset += 2, false) != 0x45786966) return callback(-1);
                        const little = view.getUint16(offset += 6, false) == 0x4949;
                        offset += view.getUint32(offset + 4, little);
                        const tags = view.getUint16(offset, little);
                        offset += 2;
                        for (let i = 0; i < tags; i++)
                            if (view.getUint16(offset + (i * 12), little) == 0x0112)
                                return callback(view.getUint16(offset + (i * 12) + 8, little));
                    }
                    else if ((marker & 0xFF00) != 0xFF00) break;
                    else offset += view.getUint16(offset, false);
                }
                return callback(-1);
            };
            reader.readAsArrayBuffer(file);
        }

        function applyTransform(ctx, width, height, orientation) {
            switch (orientation) {
                case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
                case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
                case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
                case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
                case 7: ctx.transform(0, -1, -1, 0, height, width); break;
                case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
            }
        }

        async function startDesktopCamera() {
            const modal = document.getElementById('cameraModal'), video = document.getElementById('cameraVideo');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®åŠŸèƒ½ã€‚'); return; }
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                video.srcObject = cameraStream; video.play();
                modal.style.display = 'flex';
            } catch (err) { showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚'); console.error("æ‘„åƒå¤´è®¿é—®å¤±è´¥:", err); }
        }

        function stopDesktopCamera() {
            if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; }
            document.getElementById('cameraModal').style.display = 'none';
        }

        function takeDesktopSnapshot() {
            const video = document.getElementById('cameraVideo'), canvas = document.getElementById('cameraCanvas'), context = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            context.translate(canvas.width, 0); context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('photoPreview').innerHTML = `<img src="${imageData}" class="w-full h-full object-cover rounded-2xl">`;
            document.getElementById('photoPreview').dataset.imageData = imageData;
            stopDesktopCamera();
        }

        function saveReports(reports) {
            try {
                localStorage.setItem('safetyReports', JSON.stringify(reports));
                return true;
            } catch (error) {
                if (error.name === 'QuotaExceededError' || (error instanceof DOMException && error.code === 22)) {
                    showToast('ä¿å­˜å¤±è´¥ï¼æµè§ˆå™¨å­˜å‚¨ç©ºé—´å·²æ»¡ã€‚è¯·å°è¯•åˆ é™¤ä¸€äº›æ—§æŠ¥å‘Šã€‚');
                } else {
                    showToast('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”±äºæµè§ˆå™¨è®¾ç½®(å¦‚æ— ç—•æ¨¡å¼)æˆ–æƒé™é—®é¢˜å¯¼è‡´ã€‚');
                }
                console.error("ä¿å­˜åˆ°LocalStorageå¤±è´¥:", error);
                return false;
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn?.addEventListener('click', () => showPage(btn.dataset.page)));
            document.getElementById('startBtn')?.addEventListener('click', () => showPage('capture'));
            document.getElementById('addReportBtn')?.addEventListener('click', () => showPage('capture'));

            // æµ‹è¯•ç›¸å…³äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.quiz-mode-card').forEach(card => {
                card.addEventListener('click', () => {
                    const mode = card.dataset.mode;
                    startQuizMode(mode);
                });
            });

            document.getElementById('showLeaderboard')?.addEventListener('click', showLeaderboardInterface);
            document.getElementById('backToModes')?.addEventListener('click', showQuizModeSelection);
            document.getElementById('backFromLeaderboard')?.addEventListener('click', showQuizModeSelection);
            document.getElementById('clearStatsBtn')?.addEventListener('click', clearAllStats);

            document.getElementById('myReportsList')?.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) showPage('capture', editBtn.dataset.id);
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) { reportToDeleteId = deleteBtn.dataset.id; document.getElementById('deleteConfirmModal').classList.remove('hidden'); }
            });

            document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
                if (!reportToDeleteId) return;
                let reports = JSON.parse(localStorage.getItem('safetyReports')) || [];
                reports = reports.filter(r => r.id != reportToDeleteId);
                if (saveReports(reports)) { showSuccessModal('åˆ é™¤æˆåŠŸ', 'æŠ¥å‘Šå·²æˆåŠŸä»æœ¬åœ°åˆ é™¤ã€‚'); }
                document.getElementById('deleteConfirmModal').classList.add('hidden');
                reportToDeleteId = null;
                renderMyReports();
            });

            document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => { document.getElementById('deleteConfirmModal').classList.add('hidden'); reportToDeleteId = null; });
            document.getElementById('knowledgeSearch')?.addEventListener('input', e => { filteredKnowledge = knowledgeData.filter(item => (item.title + item.content + item.category).toLowerCase().includes(e.target.value.toLowerCase())); knowledgeCurrentPage = 1; renderPaginatedKnowledge(); });
            document.getElementById('casesSearch')?.addEventListener('input', e => { filteredCases = casesData.filter(item => (item.title + item.description + item.lesson + item.type).toLowerCase().includes(e.target.value.toLowerCase())); casesCurrentPage = 1; renderPaginatedCases(); });
            document.getElementById('marineSearch')?.addEventListener('input', e => { filteredMarine = marineEducationData.filter(item => (item.title + item.content + item.category + item.location + item.tips.join(' ')).toLowerCase().includes(e.target.value.toLowerCase())); marineCurrentPage = 1; renderPaginatedMarine(); });
            document.getElementById('takePhotoBtn')?.addEventListener('click', () => isMobileDevice() ? document.getElementById('mobileCameraInput').click() : startDesktopCamera());
            document.getElementById('uploadPhotoBtn')?.addEventListener('click', () => document.getElementById('uploadInput').click());
            document.getElementById('mobileCameraInput')?.addEventListener('change', handleImageSelection);
            document.getElementById('uploadInput')?.addEventListener('change', handleImageSelection);
            document.getElementById('closeCameraBtn')?.addEventListener('click', stopDesktopCamera);
            document.getElementById('snapBtn')?.addEventListener('click', takeDesktopSnapshot);

            document.querySelectorAll('.risk-btn').forEach(btn => btn?.addEventListener('click', function () {
                document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('bg-green-100', 'bg-yellow-100', 'bg-red-100', 'dark:bg-green-900/50', 'dark:bg-yellow-900/50', 'dark:bg-red-900/50', 'font-bold'));
                const level = this.dataset.level;
                const colorClass = { low: 'green', medium: 'yellow', high: 'red' }[level];
                this.classList.add(`bg-${colorClass}-100`, `dark:bg-${colorClass}-900/50`, `font-bold`);
                selectedRiskLevel = level;
            }));

            document.getElementById('submitReport')?.addEventListener('click', () => {
                const type = document.getElementById('hazardType').value, desc = document.getElementById('hazardDesc').value;
                const riskLevel = selectedRiskLevel, imageData = document.getElementById('photoPreview').dataset.imageData;
                if (!imageData) { showToast('è¯·å…ˆæ‹æ‘„æˆ–ä¸Šä¼ ä¸€å¼ ç…§ç‰‡ï¼'); return; }
                if (!type) { showToast('è¯·é€‰æ‹©éšæ‚£ç±»å‹ï¼'); return; }
                if (!desc) { showToast('è¯·å¡«å†™éšæ‚£æè¿°ï¼'); return; }
                if (!riskLevel) { showToast('è¯·é€‰æ‹©å±é™©ç­‰çº§ï¼'); return; }

                let reports = JSON.parse(localStorage.getItem('safetyReports')) || [];
                let success = false;
                if (editingReportId) {
                    const reportIndex = reports.findIndex(r => r.id == editingReportId);
                    if (reportIndex > -1) {
                        reports[reportIndex] = { ...reports[reportIndex], type, description: desc, riskLevel, imageData, timestamp: new Date().toISOString() };
                        if (saveReports(reports)) { showSuccessModal('æ›´æ–°æˆåŠŸ', 'æ‚¨çš„éšæ‚£æŠ¥å‘Šå·²æˆåŠŸæ›´æ–°ã€‚'); success = true; }
                    }
                } else {
                    const newReport = { id: Date.now(), type, description: desc, riskLevel, imageData, timestamp: new Date().toISOString() };
                    reports.push(newReport);
                    if (saveReports(reports)) { showSuccessModal('æäº¤æˆåŠŸ', 'æ‚¨çš„éšæ‚£æŠ¥å‘Šå·²ä¿å­˜è‡³æœ¬åœ°ã€‚'); success = true; }
                }
                if (success) { resetCaptureForm(); editingReportId = null; }
            });

            document.getElementById('closeModal')?.addEventListener('click', () => { document.getElementById('successModal').classList.add('hidden'); showPage('my-reports'); });
        }

        async function main() {
            const dataLoaded = await loadAllData();
            if (!dataLoaded) return;
            const loader = document.getElementById('loader');
            const app = document.getElementById('app');
            if (loader) loader.remove();
            if (app) app.classList.remove('hidden');

            if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
            window.matchMedia?.('(prefers-color-scheme: dark)').addEventListener('change', e => document.documentElement.classList.toggle('dark', e.matches));

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('knowledgeCount').textContent = knowledgeData.length;
            document.getElementById('marineCount').textContent = marineEducationData.length;

            setupEventListeners();
            showPage('home');
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>

</html>